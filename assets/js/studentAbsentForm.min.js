var remainMathAbsent=0,remainPhyAbsent=0;$(document).ready(function(){let a=getCookieDict(),b=a.monkeyWebUser,c=[],d=[];$.post("post/getConfig",function(e){let f=e.defaultQuarter.quarter.year,g=e.defaultQuarter.quarter.quarter;$("#pageHead").html("CR60Q"+g+" & FHB"),$.post("post/studentProfile",{studentID:b},function(h){$.post("post/gradeCourse",{grade:h.grade,year:f,quarter:g},function(k){for(let l=0;l<h.courseID.length;l++)for(let m=0;m<k.course.length;m++)h.courseID[l]===k.course[m].courseID&&c.push(k.course[m]);$.post("post/v1/listStudentHybrid",{studentID:b,year:f,quarter:g},function(l){for(let m=0;m<l.length;m++)d.push(l[m]);fillButt(c,d),fillSummary(b,d)})})})}),$("#datePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5],minDate:moment()}),$("#datePicker").on("dp.change",function(){fillButt(c,d),fillSummary(b,d)}),$(".btn-default").click(function(){"&nbsp;"!=$(this).html()&&$(this).toggleClass("btn-default btn-success")}),$("#submit").click(function(){if(!(0<$(".btn-success").length))alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E40\u0E25\u0E37\u0E2D\u0E01\u0E27\u0E34\u0E0A\u0E32\u0E17\u0E35\u0E48\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E32");else if(!$("#reasonInput").val())alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E40\u0E2B\u0E15\u0E38\u0E1C\u0E25\u0E43\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32");else if($("#senderInput").val()){let e=!0;for(let f=0;f<$(".btn-success").length;f++)e&&("PH"==$($(".btn-success")[f]).html().slice(5)&&0>=remainPhyAbsent?(e=!1,alert("\u0E25\u0E32 FHB:P \u0E04\u0E23\u0E1A\u0E08\u0E33\u0E19\u0E27\u0E19\u0E41\u0E25\u0E49\u0E27")):"M"==$($(".btn-success")[f]).html().slice(5)&&0>=remainMathAbsent&&(e=!1,alert("\u0E25\u0E32 FHB:M \u0E04\u0E23\u0E1A\u0E08\u0E33\u0E19\u0E27\u0E19\u0E41\u0E25\u0E49\u0E27")));e&&(log("Send data =>"),sendData(b))}else alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E0A\u0E37\u0E48\u0E2D\u0E1C\u0E39\u0E49\u0E41\u0E08\u0E49\u0E07")})});function sendData(a){let b=$("#datePicker").data("DateTimePicker").date(),c=!0,d=[];if(emer(b)&&(c=confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E32\u0E09\u0E38\u0E01\u0E40\u0E09\u0E34\u0E19")),c){let e=moment().date(b.date()).month(b.month()).year(b.year()).minute(0).second(0).millisecond(0);if(2==b.day()||4==b.day())d.push(parseInt(e.hour(17).valueOf()));else for(let f=0;f<$(".btn-success").length;f++)d.push(parseInt(e.hour($($(".btn-success")[f]).attr("id").slice(3)).valueOf()))}log(d),$.post("post/addStudentAbsenceModifier",{studentID:a,day:d,reason:$("#reasonInput").val(),sender:$("#senderInput").val()},function(){location.reload()})}function emer(a){let b=moment().minute(0).second(0).millisecond(0),c=moment().year(a.year()).month(a.month()).date(a.date()).hour(18).minute(0).second(0).millisecond(0),d=86400000;return 0==a.day()?!(c.valueOf()-b.valueOf()>2*d):!(c.valueOf()-b.valueOf()>d)}function fillButt(a,b){$(".selector").html("&nbsp;").addClass("disabled btn-default").removeClass("btn-success");let c=$("#datePicker").data("DateTimePicker").date();if(2==c.day()||4==c.day())for(let e,d=0;d<b.length;d++)e=moment(b[d].day),e.day()==c.day()&&$("#btn8").html("FHB: "+b[d].subject).removeClass("disabled");else{for(let e,d=0;d<a.length;d++)e=moment(a[d].day),e.day()==c.day()&&$.post("post/name",{userID:a[d].tutor[0]},function(f){$("#btn"+e.hour()).html(a[d].courseName+" - "+f.nicknameEn).removeClass("disabled")});for(let e,d=0;d<b.length;d++)e=moment(b[d].day),e.day()==c.day()&&$("#btn"+e.hour()).html("FHB: "+b[d].subject).removeClass("disabled")}}function fillSummary(a,b){let c=0,d=0;remainPhyAbsent=0,remainMathAbsent=0,$("#summaryPhy").empty().html("FHB:Physic&nbsp;"),$("#summaryMath").empty().html("FHB:Math&nbsp;");for(let g=0;g<b.length;g++)"PH"===b[g].subject?remainPhyAbsent+=3:remainMathAbsent+=3;c=remainPhyAbsent,d=remainMathAbsent;let e=$("#datePicker").data("DateTimePicker").date(),f=moment().day(e.day()).month(e.month()-3).year(e.year()).hour(0).minute(0).second(0).millisecond(0);$.post("post/listStudentAttendanceModifierByStudent",{studentID:a,start:f.valueOf()},function(g){for(let h=0;h<g.modifier.length;h++)if("absence"===g.modifier[h].type&&g.modifier[h].day<=e.valueOf()&&"\u0E25\u0E32"!=g.modifier[h].reason&&"\u0E40\u0E1E\u0E34\u0E48\u0E21"!=g.modifier[h].reason)for(let k=0;k<b.length;k++)moment(b[k].day).day()==moment(g.modifier[h].day).day()&&moment(b[k].day).hour()==moment(g.modifier[h].day).hour()&&("PH"===b[k].subject?remainPhyAbsent-=1:remainMathAbsent-=1);for(let h=0;h<d;h++)$("#summaryMath").append("<span class='glyphicon glyphicon-record' style='color:"+(h>=remainMathAbsent?"red":"green")+"'></span>");for(let h=0;h<c;h++)$("#summaryPhy").append("<span class='glyphicon glyphicon-record' style='color:"+(h>=remainPhyAbsent?"red":"green")+"'></span>")})}