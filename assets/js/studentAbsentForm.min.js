var useM=0,useP=0,maxM=0,maxP=0;$(document).ready(function(){let a=getCookieDict(),b=a.monkeyWebUser,c=2017,d=4,e=[],f=[];$("#datePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5],minDate:moment()}),$.post("post/getConfig",g=>{c=g.defaultQuarter.quarter.year,d=g.defaultQuarter.quarter.quarter,$("#pageHead").html("CR60Q"+g.defaultQuarter.quarter.quarter+" & FHB")}).then($.post("post/studentProfile",{studentID:b},g=>{let h=[];for(let k in g.courseID)h.push($.post("post/courseInfo",{courseID:g.courseID[k]}));Promise.all([Promise.all(h).then(k=>{for(let l in k)k[l].quarter===d&&e.push(k[l])}),$.post("post/v1/listStudentHybrid",{studentID:b,year:c,quarter:d},k=>{for(let l in k)f.push(k[l]),"M"==k[l].subject?maxM+=3:maxP+=3})]).then(()=>{fillTable(b,f,e),fillButt(e,f)})})),$("#datePicker").on("dp.change",function(){fillTable(b,f,e),fillButt(e,f)}),$(".selector").click(function(){$(this).hasClass("disabled")||$(this).toggleClass("btn-default btn-success")}),$("#submit").click(function(){let g=haveFHB();0==$(".btn-success").length?alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E40\u0E25\u0E37\u0E2D\u0E01\u0E27\u0E34\u0E0A\u0E32\u0E17\u0E35\u0E48\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E32"):$("#reasonInput").val()?$("#senderInput").val()?0>=maxM-useM&&g[0]?alert("\u0E25\u0E32 FHB:M \u0E04\u0E23\u0E1A\u0E41\u0E25\u0E49\u0E27"):0>=maxP-useP&&g[1]?alert("\u0E25\u0E32 FHB:P \u0E04\u0E23\u0E1A\u0E41\u0E25\u0E49\u0E27"):sendData(b):alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E0A\u0E37\u0E48\u0E2D\u0E1C\u0E39\u0E49\u0E41\u0E08\u0E49\u0E07"):alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E40\u0E2B\u0E15\u0E38\u0E1C\u0E25")})});function fillButt(a,b){$(".selector").addClass("disabled btn-default").removeClass("btn-success").html("&nbsp;");let c=$("#datePicker").data("DateTimePicker").date();if(2==c.day()||4==c.day())for(let d in b)moment(b[d].day).day()==c.day()&&$("#btn8").html("FHB:"+b[d].subject.slice(0,1)).removeClass("disabled");else{for(let d in b)moment(b[d].day).day()==c.day()&&$("#btn"+moment(b[d].day).hour()).html("FHB:"+b[d].subject.slice(0,1)).removeClass("disabled");for(let d in a)moment(a[d].day).day()==c.day()&&$("#btn"+moment(a[d].day).hour()).html(a[d].courseName).removeClass("disabled")}}function fillTable(a,b,c){useP=0,useM=0,$("#absentTableBody").empty(),$("#presentTableBody").empty();let d=$("#datePicker").data("DateTimePicker").date(),e=moment(0).year(d.year()).month(d.month()-3).date(d.date());$.post("post/listStudentAttendanceModifierByStudent",{studentID:a,start:e.valueOf()},f=>{for(let g in f.modifier)if("addFHB:M"==f.modifier[g].reason)useM-=1,$("#presentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+" - <strong>FHB:M</strong></td></tr>");else if("addFHB:P"==f.modifier[g].reason)useP-=1,$("#presentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+"- <strong>FHB:P</strong></td></tr>");else if("\u0E25\u0E32"!=f.modifier[g].reason&&"\u0E40\u0E1E\u0E34\u0E48\u0E21"!=f.modifier[g].reason){for(let h=0;h<b.length;h++)if(moment(b[h].day).hour()==moment(f.modifier[g].day).hour()&&moment(b[h].day).day()==moment(f.modifier[g].day).day()){let k="";"M"==b[h].subject?(useM+=1,k="FHB:M"):(useP+=1,k="FHB:P"),$("#absentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+" - <strong>"+k+"</strong></td></tr>")}for(let h=0;h<c.length;h++)moment(c[h].day).hour()==moment(f.modifier[g].day).hour()&&moment(c[h].day).day()==moment(f.modifier[g].day).day()&&$("#absentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+" - <strong>"+c[h].courseName+"</strong></td></tr>")}$("#mathSum").html("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:M \u0E40\u0E2B\u0E25\u0E37\u0E2D "+(maxM-useM)+"/"+maxM),$("#phySum").html("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:P \u0E40\u0E2B\u0E25\u0E37\u0E2D "+(maxP-useP)+"/"+maxP)})}function haveFHB(){let a=[!1,!1];for(let b=0;b<$(".btn-success").length;b++)"FHB:M"==$($(".btn-success")[b]).html()&&(a[0]=!0),"FHB:P"==$($(".btn-success")[b]).html()&&(a[1]=!0);return a}function sendData(a){let b=$("#datePicker").data("DateTimePicker").date(),c=emergencyCheck(b);c?confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E32\u0E09\u0E38\u0E01\u0E40\u0E09\u0E34\u0E19")&&sendAbsentModifier(a,b):sendAbsentModifier(a,b)}function emergencyCheck(a){let b=moment(),c=moment(0).year(a.year()).month(a.month()).date(a.date()).hour(18),d=86400000;return 0==a.day()?!!(c.valueOf()-b.valueOf()<2*d):!!(c.valueOf()-b.valueOf()<d)}function sendAbsentModifier(a,b){let c=[];if(2==b.day()||4==b.day())for(let d=0;d<$(".btn-success").length;d++)c.push(b.hour(17).minute(0).second(0).millisecond(0).valueOf());else for(let e,d=0;d<$(".btn-success").length;d++)e=$($(".btn-success")[d]).attr("id").slice(3),c.push(b.hour($($(".btn-success")[d]).attr("id").slice(3)).minute(0).second(0).millisecond(0).valueOf());$.post("post/addStudentAbsenceModifier",{studentID:a,day:c,reason:$("#reasonInput").val(),sender:$("#senderInput").val()},()=>{confirm("\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32")&&location.reload()})}