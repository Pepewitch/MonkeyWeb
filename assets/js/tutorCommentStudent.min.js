$(document).ready(function(){$('body').on('touchstart.dropdown','.dropdown-menu',function(f){f.stopPropagation()});var a=[];$.post('post/allStudent').then(f=>{for(let g=0;g<f.student.length;g++)'active'===f.student[g].status&&a.push(f.student[g].nickname+' '+f.student[g].firstname+'('+f.student[g].studentID+')');$('#search-box .typeahead').typeahead({source:a})}),$('#postButton').click(function(){let f=$('#search-box .typeahead').typeahead('getActive'),g=$('#comment').val();f===void 0?alert('Please Input Student Name'):7<f.length?$.post('post/addStudentComment',{studentID:f.slice(-6,-1),tutorID:c,message:$('#comment').val()},function(){location.reload()}):alert('Please Select Correct Name')});let b=getCookieDict(),c=b.monkeyWebUser,d;writeCookie('commIndex',0),b=getCookieDict(),genPagination(1),$.post('post/position',{userID:c}).then(f=>{d=f.position,writeCookie('pos',d),showComment(d,parseInt(b.commIndex))})});function showComment(a,b){writeCookie('commIndex',b),$.post('post/listStudentCommentByIndex',{start:b,limit:20}).then(c=>{$('#commentList').empty(),20>c.comment.length?$('.next').hide():20===c.comment.length?$.post('post/listStudentCommentByIndex',{start:b+20,limit:1}).then(d=>{0===d.comment.length?$('.next').hide():$('.next').show()}):$('.next').show(),0===parseInt(b)?$('.previous').hide():$('.previous').show(),genPagination(b/20+1),0===c.comment.length&&showComment(a,b-20),'tutor'===a?getName(c,0):getNameAdmin(c,0)})}function getName(a,b){log('======recur======:'+b),$.post('post/name',{userID:a.comment[b].tutorID}).then(c=>{$.post('post/name',{userID:a.comment[b].studentID}).then(d=>{let f=moment(a.comment[b].timestamp,'x').format('DD MMM'),g='<h4><span style=\'color:green\' class=\'glyphicon glyphicon-ok'+(a.comment[b].isCleared?'':' hidden')+'\'></span><span class=\'glyphicon glyphicon-pushpin'+(0<a.comment[b].priority?'':' hidden')+'\' style=\'color:red\'></span> '+c.nickname+' -> '+d.nickname+' '+d.firstname+' ('+f+')</h4>';$('#commentList').append(g),$('#commentList').append('<p>'+a.comment[b].message+'</p>'),b<a.comment.length-1&&getName(a,b+1)})})}function getNameAdmin(a,b){log('======recur======:'+b),$.post('post/name',{userID:a.comment[b].tutorID}).then(c=>{$.post('post/name',{userID:a.comment[b].studentID}).then(d=>{let f=moment(a.comment[b].timestamp,'x').format('DD MMM');$('#commentList').append('<div class=\'dropdown\'></div>');let g='<h4 class=\'dropdown-toggle\' data-toggle=\'dropdown\'><span style=\'color:green\' class=\'glyphicon glyphicon-ok'+(a.comment[b].isCleared?'':' hidden')+'\'></span><span style=\'color:red\' class=\'glyphicon glyphicon-pushpin'+(0<a.comment[b].priority?'':' hidden')+'\'></span> '+c.nickname+' -> '+d.nickname+' '+d.firstname+' ('+f+') <span class=\'glyphicon glyphicon-option-vertical\'></span></h4>';$('.dropdown:last-child').append(g),$('.dropdown:last-child').append('<ul class=\'dropdown-menu\'><li><a onClick=\'clearComment("'+a.comment[b].commentID+'")\'>CLEAR</a></li><li><a onClick=\'addPin("'+a.comment[b].commentID+'")\'>PIN</a></li><li><a onClick=\'rmPin("'+a.comment[b].commentID+'")\'>UNPIN</a></li><li><a onClick=\'rmComm("'+a.comment[b].commentID+'")\'>REMOVE</a></li></ul>'),$('#commentList').append('<p>'+a.comment[b].message+'</p>'),b<a.comment.length-1&&getNameAdmin(a,b+1)})})}function commPosition(a){let b=getCookieDict(),c;c=0<a?parseInt(b.commIndex)+20:parseInt(b.commIndex)-20;let d=b.pos;showComment(d,c)}function clearComment(a){let b=getCookieDict(),c=b.pos;$.post('post/clearStudentComment',{commentID:a,isCleared:!0}).then(()=>{showComment(c,parseInt(b.commIndex))})}function addPin(a){let b=getCookieDict(),c=b.pos;$.post('post/changeStudentCommentPriority',{commentID:a,priority:1}).then(()=>{showComment(c,parseInt(b.commIndex))})}function rmPin(a){let b=getCookieDict(),c=b.pos;$.post('post/changeStudentCommentPriority',{commentID:a,priority:0}).then(()=>{showComment(c,parseInt(b.commIndex))})}function rmComm(a){let b=getCookieDict(),c=b.pos;$.post('post/removeStudentComment',{commentID:a}).then(()=>{showComment(c,parseInt(b.commIndex))})}function genPagination(a){$('.pagination').empty();let b=getCookieDict(),c=b.pos;if(3>=a)for(let d=1;6>d;d++)$('.pagination').append('<li id=\'page'+d+'\'><a onClick="showComment(\''+c+'\','+20*(d-1)+')">'+d+'</a></li>');else for(let d=a-2;d<a+3;d++)$('.pagination').append('<li id=\'page'+d+'\'><a onClick="showComment(\''+c+'\','+20*(d-1)+')">'+d+'</a></li>');$('#page'+a).addClass('active')}