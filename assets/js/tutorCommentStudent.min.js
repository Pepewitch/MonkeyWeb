'use strict';$(document).ready(function(){$('body').on('touchstart.dropdown','.dropdown-menu',function(f){f.stopPropagation()});var a=[];$.post('post/allStudent').then(function(f){for(var g=0;g<f.student.length;g++)'active'===f.student[g].status&&a.push(f.student[g].nickname+' '+f.student[g].firstname+'('+f.student[g].studentID+')');$('#search-box .typeahead').typeahead({source:a})}),$('#uploadButton').click(function(){$('#uploadModal').modal()}),$('#postButton').click(function(){var f=$('#search-box .typeahead').typeahead('getActive'),g=$('#file-1'),h=g.val().split('.').pop().toLowerCase();if(!(f!==void 0))alert('Please Input Student Name');else if(7<f.length){var j=new FormData;if(j.append('studentID',f.slice(-6,-1)),j.append('tutorID',c),j.append('message',$('#comment').val()),log(h),''===h)log('No Picture'),$.ajax({url:'post/addStudentComment',type:'POST',data:j,processData:!1,contentType:!1,success:function success(){location.reload()}});else if(-1===$.inArray(h,['png','jpg','jpeg']))alert('\u0E01\u0E23\u0E38\u0E13\u0E32\u0E2D\u0E31\u0E1E\u0E44\u0E1F\u0E25\u0E4C .jpg, .jpeg \u0E2B\u0E23\u0E37\u0E2D .png \u0E40\u0E17\u0E48\u0E32\u0E19\u0E31\u0E49\u0E19');else{var k=g.get(0).files;if(0<k.length){for(var m,l=0;l<k.length;l++)m=k[l],j.append('attachment',m,m.name);$.ajax({url:'post/addStudentComment',type:'POST',data:j,processData:!1,contentType:!1,success:function success(){location.reload()}})}}}else alert('Please Select Correct Name')});var b=getCookieDict(),c=b.monkeyWebUser,d;writeCookie('commIndex',0),b=getCookieDict(),genPagination(1),$.post('post/position',{userID:c}).then(function(f){d=f.position,writeCookie('pos',d),showComment(d,parseInt(b.commIndex))})});function showComment(a,b){writeCookie('commIndex',b),$.post('post/listStudentCommentByIndex',{start:b,limit:20}).then(function(c){$('#commentList').empty(),20>c.comment.length?$('.next').hide():20===c.comment.length?$.post('post/listStudentCommentByIndex',{start:b+20,limit:1}).then(function(d){0===d.comment.length?$('.next').hide():$('.next').show()}):$('.next').show(),0===parseInt(b)?$('.previous').hide():$('.previous').show(),genPagination(b/20+1),0===c.comment.length&&showComment(a,b-20),'tutor'===a?getName(c,0):getNameAdmin(c,0)})}function getName(a,b){$.post('post/name',{userID:a.comment[b].tutorID}).then(function(c){$.post('post/name',{userID:a.comment[b].studentID}).then(function(d){var f=moment(a.comment[b].timestamp,'x').format('DD MMM'),g='<h4><span class=\'glyphicon glyphicon-pushpin\''+(0<a.comment[b].priority?'style=\'color:red\'':'style=\'color:silver\'')+'></span><span class=\'glyphicon glyphicon-ok\''+(a.comment[b].isCleared?'style=\'color:green\'':'style=\'color:silver\'')+'></span>'+c.nickname+' -> '+d.nickname+' '+d.firstname+' ('+f+') </h4>';$('#commentList').append(g),$('#commentList').append('<p>'+a.comment[b].message+'</p>'),a.comment[b].hasAttachment?$.post('post/getConfig').then(function(h){var j=h.studentCommentPicturePath;j=j.slice(j.search('MonkeyWebData')+14)+a.comment[b].commentID,$.get(j+'.jpg').done(function(){$('#commentList').append('<div class=\'row\'><img class=\'col-sm-4 col-xs-10\' src=\''+j+'.jpg\' class=\'img-thumbnail\'></div>'),b<a.comment.length-1&&getName(a,b+1)}).fail(function(){$.get(j+'.jpeg').done(function(){$('#commentList').append('<div class=\'row\'><img class=\'col-sm-4 col-xs-10\' src=\''+j+'.jpeg\' class=\'img-thumbnail\'></div>'),b<a.comment.length-1&&getName(a,b+1)}).fail(function(){$.get(j+'.png').done(function(){$('#commentList').append('<div class=\'row\'><img class=\'col-sm-4 col-xs-10\' src=\''+j+'.png\' class=\'img-thumbnail\'></div>'),b<a.comment.length-1&&getName(a,b+1)}).fail(function(){b<a.comment.length-1&&getName(a,b+1)})})})}):b<a.comment.length-1&&getName(a,b+1)})})}function getNameAdmin(a,b){$.post('post/name',{userID:a.comment[b].tutorID}).then(function(c){$.post('post/name',{userID:a.comment[b].studentID}).then(function(d){var f=moment(a.comment[b].timestamp,'x').format('DD MMM'),g='<h4><span class=\'glyphicon glyphicon-pushpin\''+(0<a.comment[b].priority?'style=\'color:red\'':'style=\'color:silver\'')+'onClick=\'pin("'+a.comment[b].commentID+'",'+(0<a.comment[b].priority?0:1)+');\'></span><span class=\'glyphicon glyphicon-ok\''+(a.comment[b].isCleared?'style=\'color:green\'':'style=\'color:silver\'')+'onClick=\'clearComm("'+a.comment[b].commentID+'",'+(a.comment[b].isCleared?0:1)+');\'></span>'+c.nickname+' -> '+d.nickname+' '+d.firstname+' ('+f+') <span class=\'glyphicon glyphicon-trash\' style=\'color:red\' onClick=\'rmComm("'+a.comment[b].commentID+'");\'></span></h4>';$('#commentList').append(g),$('#commentList').append('<p>'+a.comment[b].message+'</p>'),a.comment[b].hasAttachment?$.post('post/getConfig').then(function(h){var j=h.studentCommentPicturePath;j=j.slice(j.search('MonkeyWebData')+14)+a.comment[b].commentID,$.get(j+'.jpg').done(function(){$('#commentList').append('<div class=\'row\'><img class=\'col-sm-4 col-xs-10\' src=\''+j+'.jpg\' class=\'img-thumbnail\'></div>'),b<a.comment.length-1&&getNameAdmin(a,b+1)}).fail(function(){$.get(j+'.jpeg').done(function(){$('#commentList').append('<div class=\'row\'><img class=\'col-sm-4 col-xs-10\' src=\''+j+'.jpeg\' class=\'img-thumbnail\'></div>'),b<a.comment.length-1&&getNameAdmin(a,b+1)}).fail(function(){$.get(j+'.png').done(function(){$('#commentList').append('<div class=\'row\'><img class=\'col-sm-4 col-xs-10\' src=\''+j+'.png\' class=\'img-thumbnail\'></div>'),b<a.comment.length-1&&getNameAdmin(a,b+1)}).fail(function(){b<a.comment.length-1&&getNameAdmin(a,b+1)})})})}):b<a.comment.length-1&&getNameAdmin(a,b+1)})})}function commFirst(){var a=getCookieDict(),b=a.pos;showComment(b,0)}function commLast(){alert('This function can\'t use now')}function commPosition(a){var b=getCookieDict(),c;c=0<a?parseInt(b.commIndex)+20:parseInt(b.commIndex)-20;var d=b.pos;showComment(d,c)}function clearComm(a,b){var c=getCookieDict(),d=c.pos;log(a+','+b),$.post('post/clearStudentComment',{commentID:a,isCleared:b}).then(function(){showComment(d,parseInt(c.commIndex))})}function pin(a,b){var c=getCookieDict(),d=c.pos;$.post('post/changeStudentCommentPriority',{commentID:a,priority:b}).then(function(){showComment(d,parseInt(c.commIndex))})}function rmComm(a){var b=getCookieDict(),c=b.pos;!0===confirm('\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E1A comment \u0E19\u0E35\u0E49')&&$.post('post/removeStudentComment',{commentID:a}).then(function(){showComment(c,parseInt(b.commIndex))})}function genPagination(a){$('.pagination').empty();var b=getCookieDict(),c=b.pos;if(3>=a)for(var d=1;6>d;d++)$('.pagination').append('<li id=\'page'+d+'\'><a onClick="showComment(\''+c+'\','+20*(d-1)+')">'+d+'</a></li>');else for(var f=a-2;f<a+3;f++)$('.pagination').append('<li id=\'page'+f+'\'><a onClick="showComment(\''+c+'\','+20*(f-1)+')">'+f+'</a></li>');$('#page'+a).addClass('active')}