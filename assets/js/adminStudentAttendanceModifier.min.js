let genFhbTable=(()=>{var a=_asyncToGenerator(function*(){$("#fhbAbsentTable").empty(),$("#fhbPresentTable").empty();let b=$("#fhbDatePicker").data("DateTimePicker").date();b.hour(0);let c=yield $.post("post/v1/listAttendance",{date:b.valueOf()}),d=[],e=[];for(let h in c)e.push(name(c[h].userID)),0===c[h].courseID?d.push($.post("post/v1/studentHybridSubject",{studentID:c[h].userID,hybridID:c[h].hybridID})):d.push(courseInfo(c[h].courseID));let f=yield Promise.all(d),g=yield Promise.all(e);for(let h=0;h<c.length;h++){let j=moment(c[h].timestamp).format("ddd DD/MM/YY HH:mm"),k=moment(c[h].date).hour(),l="";if(emergencyAbsent(c[h].timestamp,c[h].date)&&(l="table-warning"),1===c[h].type){let m,n,o;if(0===c[h].courseID)m="FHB:"+f[h].subject,n="HB",o="FHB";else if(m="CR:"+f[h].courseName,99000===f[h].tutor[0])n="HB",o="HB";else{let p=yield name(f[h].tutor[0]);n=p.nicknameEn,o="CR"}$("#fhbAbsentTable").append("<tr id='"+c[h].attendanceID+"' class='fhbTableRow row"+k+" "+o+" "+l+"'><td class='text-center'>"+j+"</td><td class='text-center' onclick='gotoStdProfile(\""+c[h].userID+"\")'>"+g[h].nickname+" "+g[h].firstname+"</td><td class='text-center'>"+m+"</td><td class='text-center'>"+n+"</td><td class='text-center'>"+c[h].reason+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+c[h].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>")}else $("#fhbPresentTable").append("<tr id='"+c[h].attendanceID+"' class='fhbTableRow row"+k+"'><td class='text-center'>"+j+"</td><td class='text-center' onclick='gotoStdProfile(\""+c[h].userID+"\")'>"+g[h].nickname+" "+g[h].firstname+"</td><td class='text-center'>FHB:"+c[h].subject+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+c[h].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>")}filterFhbTable()});return function(){return a.apply(this,arguments)}})(),genActivityTable=(()=>{var a=_asyncToGenerator(function*(){let b=moment().valueOf(),c=yield $.post("post/v1/listAttendance",{startDate:0,endDate:b}),d=[],e=[];for(let h in c)e.push(name(c[h].userID)),0===c[h].courseID?d.push($.post("post/v1/studentHybridSubject",{studentID:c[h].userID,hybridID:c[h].hybridID})):d.push(courseInfo(c[h].courseID));let f=yield Promise.all(d),g=yield Promise.all(e);for(let h=0;h<c.length;h++){let j,k=moment(c[h].timestamp).format("ddd DD/MM/YY - HH:mm"),l,m=moment(c[h].date).format("ddd DD/MM/YY - HH:mm"),n;1===c[h].type?(j="table-danger",l=0===c[h].courseID?"FHB:"+f[h].subject:"CR:"+f[h].courseName,n=c[h].reason):(j="table-success",l="FHB:"+c[h].subject,n="-"),$("#acTableBody").append("<tr class='"+j+"' id='"+c[h].attendanceID+"'><td class='text-center'>"+k+"</td><td class='text-center' onclick='gotoStdProfile(\""+c[h].userID+"\")'>"+g[h].nickname+" "+g[h].firstname+"</td><td class='text-center'>"+l+"</td><td class='text-center'>"+m+"</td><td class='text-center'>"+n+"</td><td class='text-center'>"+c[h].sender+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+c[h].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>")}});return function(){return a.apply(this,arguments)}})(),sendAddAdtendData=(()=>{var a=_asyncToGenerator(function*(){let b=$("#addDatePicker").data("DateTimePicker").date(),c=$("#addType").val(),d=parseInt($("#addTime").val()),e=$("#addStdID").val(),f=$("#addSubj").val();if("1"===c){let g=[],h=yield $.post("post/v1/studentTimeTable",{year:year,quarter:quarter,studentID:e}),j=h.course;for(let l in j){let m=moment(j[l].day);m.day()===b.day()&&m.hour()===d&&g.push($.post("post/v1/addStudentAbsent",{userID:e,date:roundTime(b,d),courseID:j[l].courseID,reason:$("#addReason").val(),sender:"Admin"}))}let k=h.hybrid;for(let l in k){let m=moment(k[l].day);m.day()===b.day()&&m.hour()===d&&g.push($.post("post/v1/addStudentAbsent",{userID:e,date:roundTime(b,d),hybridID:k[l].hybridID,reason:$("#addReason").val(),sender:"Admin"}))}location.reload()}else{let g=yield $.post("post/v1/listHybridDayInQuarter",{year:year,quarter:quarter}),h;for(let j in g){let k=moment(g[j].day);k.day()===b.day()&&k.hour()===d&&(h=g[j].hybridID)}yield $.post("post/v1/addStudentPresent",{userID:e,date:roundTime(b,d),hybridID:h,subject:f,sender:"Admin"}),location.reload()}});return function(){return a.apply(this,arguments)}})();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(c,d){function e(f,g){try{var h=b[f](g),j=h.value}catch(k){return void d(k)}return h.done?void c(j):Promise.resolve(j).then(function(k){e("next",k)},function(k){e("throw",k)})}return e("next")})}}let year,quarter;getYearAndQuarter();function getYearAndQuarter(){getConfig().then(a=>{year=a.defaultQuarter.quarter.year,quarter=a.defaultQuarter.quarter.quarter})}$("#fhbDatePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5]}),genTimePicker(),genFhbTable(),$("#fhbDatePicker").on("dp.change",function(){genTimePicker(),genFhbTable()});function genTimePicker(){$("#fhbTimePick").empty();let a=$("#fhbDatePicker").data("DateTimePicker").date();2===a.day()||4===a.day()?$("#fhbTimePick").append("<option value=17>17-19</option>"):$("#fhbTimePick").append("<option value=8>8-10</option><option value=10>10-12</option><option value=13>13-15</option><option value=15>15-17</option>")}function emergencyAbsent(a,b){let c=!1,d=86400000,e=moment(b);return e.hour(18).minute(0).second(0).millisecond(0),0===e.day()?e.valueOf()-a<2*d&&(c=!0):e.valueOf()-a<d&&(c=!0),c}function filterFhbTable(){let a=$("#fhbTimePick").val(),b=$("#fhbFilterPick").val();switch($(".fhbTableRow").hide(),$(".row"+a).show(),b){case"FHB":$(".HB").hide(),$(".CR").hide();break;case"HB":$(".CR").hide();break;case"CR":$(".FHB").hide(),$(".HB").hide();break;default:}}$("#fhbTimePick").change(function(){filterFhbTable()}),$("#fhbFilterPick").change(function(){filterFhbTable()});function removeAdtend(a){confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E1A\u0E1B\u0E23\u0E30\u0E27\u0E31\u0E15\u0E34\u0E19\u0E35\u0E49?")&&$.post("post/v1/deleteAttendance",{attendanceID:a}).then(b=>{log(b),$("#"+a).remove()})}function gotoStdProfile(a){writeCookie("monkeyWebAdminAllstudentSelectedUser",a),self.location="/adminStudentprofile"}genActivityTable(),$("#addType").change(function(){loadAdtendPage()}),loadAdtendPage();function loadAdtendPage(){let a=$("#addType").val();"1"===a?($(".absentContent").show(),$(".addContent").hide()):($(".absentContent").hide(),$(".addContent").show())}$("#addDatePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5]}),genAddAdtendTimePicker(),$("#addDatePicker").on("dp.change",function(){genAddAdtendTimePicker()});function genAddAdtendTimePicker(){$("#addTime").empty();let a=$("#addDatePicker").data("DateTimePicker").date();2===a.day()||4===a.day()?$("#addTime").append("<option value=17>17-19</option>"):$("#addTime").append("<option value=8>8-10</option><option value=10>10-12</option><option value=13>13-15</option><option value=15>15-17</option>")}$("#addNewAttend").click(function(){let a=$("#addType").val();""===$("#addStdID").val()?alert("Input studentID"):5===$("#addStdID").val().length?"1"===a?""===$("#addReason").val()?alert("Input reason"):confirm("\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32?")&&sendAddAdtendData():confirm("\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E40\u0E1E\u0E34\u0E48\u0E21?")&&sendAddAdtendData():alert("Incorrect studentID")});const roundTime=(a,b)=>{let c=moment(0);return c.year(a.year()).month(a.month()).date(a.date()).hour(parseInt(b)),c.valueOf()};