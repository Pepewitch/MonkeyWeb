const summerQ=12,summerMonth=9,summerYear=2017,crYear=2017,crQuarter=4;$(document).ready(function(){$("#datePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5],minDate:moment()}),genCrTimePick(),genCrTable(),$("#datePicker").on("dp.change",function(){genCrTimePick(),genCrTable()}),$("#crTimePick").change(function(){genCrTable()}),genTableByName(),$("#smByName").collapse("show"),$("#aByName").click(function(){$("#smByWeek").collapse("hide"),setTimeout(function(){$("#smByName").collapse("show")},500)}),$("#aByWeek").click(function(){$("#smByName").collapse("hide"),setTimeout(function(){$("#smByWeek").collapse("show")},500)}),$("#weekSelect").change(function(){genTableByWeek()}),$("#typeSelect").change(function(){genTableByWeek()})});function genCrTimePick(){$("#crTimePick").empty();let a=$("#datePicker").data("DateTimePicker").date();2==a.day()||4==a.day()?$("#crTimePick").append("<option>17-19</option>"):($("#crTimePick").append("<option>8-10</option>"),$("#crTimePick").append("<option>10-12</option>"),$("#crTimePick").append("<option>13-15</option>"),$("#crTimePick").append("<option>15-17</option>"))}function genCrTable(){$("#crPresentTable").empty(),$("#crAbsentTable").empty();let a=$("#datePicker").data("DateTimePicker").date(),b=$("#crTimePick").val();b=b.slice(0,b.indexOf("-"));let c=moment(0).year(a.year()).month(a.month()).date(a.date()).hour(b).minute(0).second(0).millisecond(0);$.post("post/listStudentAttendanceModifierByDay",{day:c.valueOf()},d=>{let e=[],f=[];for(let g in d.absence)e.push($.post("post/studentProfile",{studentID:d.absence[g].studentID})),f.push($.post("post/v1/listStudentHybrid",{studentID:d.absence[g].studentID,quarter:crQuarter,year:crYear}));Promise.all([Promise.all(e),Promise.all(f)]).then(g=>{for(let h in d.absence)"add"==d.absence[h].reason.slice(0,3)?$("#crPresentTable").append("<tr><td class='text-center'>"+d.absence[h].studentID+"</td><td class='text-center'>"+g[0][h].nickname+" "+g[0][h].firstname+"</td><td class='text-center'>"+d.absence[h].reason.slice(3)+"</td></tr>"):($("#crAbsentTable").append("<tr class='"+(emergencyCheck(c,moment(d.absence[h].timestamp))?"warning":"")+"'><td class='text-center'>"+moment(d.absence[h].timestamp).format("DD/MM/YYYY")+"</td><td class='text-center'>"+d.absence[h].studentID+"</td><td class='text-center'>"+g[0][h].nickname+" "+g[0][h].firstname+"</td><td class='text-center absentSubject"+h+"'></td><td class='text-center'>"+d.absence[h].reason+"</td></tr>"),myFHB(g[0][h].courseID,g[1][h],c,h))})})}function myFHB(a,b,c,d){let e=[];for(let f in b)if(moment(b[f].day).day()==c.day()&&moment(b[f].day).hour()==c.hour())return void $(".absentSubject"+d).html("FHB:"+b[f].subject);for(let f in a)e.push($.post("post/courseInfo",{courseID:a[f]}));Promise.all(e).then(f=>{for(let g in log(f),f)if(f[g].quarter==crQuarter&&moment(f[g].day).day()==c.day()&&moment(f[g].day).hour()==c.hour())return void $(".absentSubject"+d).html("CR:"+f[g].courseName)})}function emergencyCheck(a,b){let c=moment(0).year(a.year()).month(a.month()).date(a.date()).hour(18),d=86400000;return 0==a.day()?!!(c.valueOf()-b.valueOf()<2*d):!!(c.valueOf()-b.valueOf()<d)}function genTableByName(){let a=[];$("#smByName").empty(),$("#smByName").append("<div class='row' id='smHeader'></div>"),$("#smHeader").append("<form class='col-sm-2'><div class='form-group'><label>Input Name:</label><input class='form-control typeahead' type='text' data-provide='typeahead' autofocus></div></form>"),$.post("post/allStudent").done(function(b){for(let c=0;c<b.student.length;c++)if("active"===b.student[c].status)for(let d=0;d<b.student[c].quarter.length;d++)b.student[c].quarter[d].quarter===summerQ&&a.push({name:b.student[c].nickname+" "+b.student[c].firstname,id:b.student[c].studentID});$(".typeahead").typeahead({source:a,autoSelect:!0}),$("#smByName").append("<div class='row'><div class='table-responsive col-sm-9'><table class='table table-hover table-bordered'><thead><tr><th colspan='4' class='danger text-center' style='font-size:2em'>\u0E25\u0E32</th></tr><tr><th class='text-center col-sm-6'>DATE</th><th class='text-center col-sm-2'>8.00-10.00</th><th class='text-center col-sm-2'>10.00-12.00</th><th class='text-center col-sm-2'>13.00-15.00</th></tr></thead><tbody id='smAbsentBody'></tbody></table></div><div class='table-responsive col-sm-3'><table class='table table-hover table-bordered'><thead><tr><th class='success text-center' style='font-size:2em'>\u0E40\u0E1E\u0E34\u0E48\u0E21</th></tr><tr><th class='text-center col-sm-6'>DATE</th></tr></thead><tbody id='smPresentBody'></tbody></table></div></div>"),$(".typeahead").change(function(){let c=$(".typeahead").typeahead("getActive");$("#smAbsentBody").empty(),$("#smPresentBody").empty(),genPickedTable(c.id)})}).fail(function(){log("=>fail to post/allStudent")})}function genPickedTable(a){let b=moment();$.post("post/listStudentAttendanceModifierByStudent",{studentID:a,start:b.valueOf()}).done(function(c){let d=moment(0);for(let e=0;e<c.modifier.length;e++)if("\u0E40\u0E1E\u0E34\u0E48\u0E21"===c.modifier[e].reason)$("#smPresentBody").append("<tr><td class='text-center'>"+moment(c.modifier[e].day).format("DD/MM/YYYY")+"</td></tr>");else if("\u0E25\u0E32"===c.modifier[e].reason){let f=moment(c.modifier[e].day).date()===d.date()&&moment(c.modifier[e].day).month()===d.month()&&moment(c.modifier[e].day).year()===d.year();f?(8===moment(c.modifier[e].day).hour()&&$(".a:last").html("\u2713"),10===moment(c.modifier[e].day).hour()&&$(".b:last").html("\u2713"),13===moment(c.modifier[e].day).hour()&&$(".c:last").html("\u2713")):(d=moment(c.modifier[e].day),$("#smAbsentBody").append("<tr></tr>"),$("#smAbsentBody tr:last-child").append("<td class='text-center'>"+moment(c.modifier[e].day).format("DD/MM/YYYY")+"</td><td class='text-center a'>"+(8===moment(c.modifier[e].day).hour()?"\u2713":"-")+"</td><td class='text-center b'>"+(10===moment(c.modifier[e].day).hour()?"\u2713":"-")+"</td><td class='text-center c'>"+(13===moment(c.modifier[e].day).hour()?"\u2713":"-")+"</td>"))}}).fail(function(){log("=>fail to post/listStudentAttendanceModifierByStudent")})}function genTableByWeek(){$("#smWeekBody").empty();const a=parseInt($("#weekSelect").val());weekDayRecur(a,a,8)}function weekDayRecur(a,b,c){if(5>b-a){let d=moment(0).date(b).month(summerMonth).year(summerYear).hour(c);$.post("post/listStudentAttendanceModifierByDay",{day:d.valueOf()}).done(function(e){log(e.absence),weekDayGetName(e.absence,0,d,a)})}}function weekDayGetName(a,b,c,d){if(b<a.length)$.post("post/name",{userID:a[b].studentID}).done(function(e){"\u0E25\u0E32"===a[b].reason&&("0"===$("#typeSelect").val()||"1"===$("#typeSelect").val())?($("#smWeekBody").append("<tr class='danger'></tr>"),$("#smWeekBody tr:last-child").append("<td class='text-center'>"+a[b].studentID+"</td><td>"+e.firstname+" ("+e.nickname+") "+e.lastname+"</td><td class='text-center'>"+c.format("DD/MM/YYYY")+"</td><td class='text-center'>"+c.format("HH:mm")+"</td>")):"\u0E40\u0E1E\u0E34\u0E48\u0E21"===a[b].reason&&("0"===$("#typeSelect").val()||"2"===$("#typeSelect").val())&&($("#smWeekBody").append("<tr class='success'></tr>"),$("#smWeekBody tr:last-child").append("<td class='text-center'>"+a[b].studentID+"</td><td>"+e.firstname+" ("+e.nickname+") "+e.lastname+"</td><td class='text-center'>"+c.format("DD/MM/YYYY")+"</td><td class='text-center'>"+c.format("HH:mm")+"</td>")),log(d),weekDayGetName(a,b+1,c,d)});else{let e=c.hour(),f=c.date();8===e?weekDayRecur(d,f,10):10===e?weekDayRecur(d,f,13):13===e?weekDayRecur(d,f,15):15===e&&weekDayRecur(d,f+1,8)}}