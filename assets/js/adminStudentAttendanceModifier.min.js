const summerQ=12,summerMonth=9,summerYear=2017,crYear=2017,crQuarter=4;let hybridDay=[];$(document).ready(function(){$("#datePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5]}),genCrTimePick(),genCrTable(),$("#datePicker").on("dp.change",function(){genCrTimePick(),genCrTable()}),$("#crTimePick").change(function(){genCrTable()}),$("#filterPick").change(function(){filterTable()}),genPnTable(),$("#acLink").click(function(){$("#acLink").hasClass("clicked")||($("#acLink").addClass("clicked"),genActivityTable())}),genSmCrPick(),genTableByName(),$("#smByName").collapse("show"),$("#aByName").click(function(){$("#smByWeek").collapse("hide"),$("#smByCourse").collapse("hide"),setTimeout(function(){$("#smByName").collapse("show")},500)}),$("#aByWeek").click(function(){$("#smByName").collapse("hide"),$("#smByCourse").collapse("hide"),setTimeout(function(){$("#smByWeek").collapse("show")},500)}),$("#aByCourse").click(function(){$("#smByName").collapse("hide"),$("#smByWeek").collapse("hide"),setTimeout(function(){$("#smByCourse").collapse("show")},500)}),$("#weekSelect").change(function(){genTableByWeek()}),$("#typeSelect").change(function(){filterSmTable()}),$("#smCrSelect").change(function(){genSmTableByCr()}),$("#addDatePicker").datetimepicker({format:"DD/MM/YYYY HH",daysOfWeekDisabled:[1,3,5]}),$("#addNewAttend").click(function(){if(!$("#addDatePicker").val())alert("Pick Day");else if(!$("#addID").val())alert("Input Student ID");else if(!$("#addSender").val())alert("Input Sender");else{let a=$("#addDatePicker").data("DateTimePicker").date().minute(0).second(0).millisecond(0).valueOf();"\u0E25\u0E32"==$("#addType").val()?$("#addReason").val()?$.post("post/addStudentAbsenceModifier",{studentID:$("#addID").val(),day:[a],reason:$("#addReason").val(),sender:$("#addSender").val()}).then(()=>{location.reload()}):alert("Input Reason"):$.post("post/addStudentAbsenceModifier",{studentID:$("#addID").val(),day:[a],reason:"add"+$("#addSubj").val(),sender:$("#addSender").val()}).then(()=>{location.reload()})}})});function relocate(a){writeCookie("monkeyWebAdminAllstudentSelectedUser",a),self.location="/adminStudentprofile"}function genCrTimePick(){$("#crTimePick").empty();let a=$("#datePicker").data("DateTimePicker").date();2==a.day()||4==a.day()?$("#crTimePick").append("<option>17-19</option>"):($("#crTimePick").append("<option>8-10</option>"),$("#crTimePick").append("<option>10-12</option>"),$("#crTimePick").append("<option>13-15</option>"),$("#crTimePick").append("<option>15-17</option>"))}function genCrTable(){$("#crPresentTable").empty(),$("#crAbsentTable").empty();let a=$("#datePicker").data("DateTimePicker").date(),b=$("#crTimePick").val();b=b.slice(0,b.indexOf("-"));let c=moment(0).year(a.year()).month(a.month()).date(a.date()).hour(b).minute(0).second(0).millisecond(0);$.post("post/listStudentAttendanceModifierByDay",{day:c.valueOf()},d=>{let e=[],f=[];for(let g in d.absence)e.push($.post("post/studentProfile",{studentID:d.absence[g].studentID})),f.push($.post("post/v1/listStudentHybrid",{studentID:d.absence[g].studentID,quarter:crQuarter,year:crYear}));Promise.all([Promise.all(e),Promise.all(f)]).then(g=>{for(let h in d.absence)"add"==d.absence[h].reason.slice(0,3)?$("#crPresentTable").append("<tr><td class='text-center'>"+moment(d.absence[h].timestamp).format("DD/MM/YYYY HH:mm")+"</td><td class='text-center' onclick='relocate("+d.absence[h].studentID+")'>"+g[0][h].nickname+" "+g[0][h].firstname+"</td><td class='text-center'>"+d.absence[h].reason.slice(3)+"</td><td class='text-center'><button id='"+d.absence[h].modifierID+"' onClick='removeAttend(this.id);' class='btn btn-light col-12'><span class='fa fa-trash'></span></button></td></tr>"):($("#crAbsentTable").append("<tr class='"+(emergencyCheck(c,moment(d.absence[h].timestamp))?"table-warning":"")+" row"+h+"'><td class='text-center'>"+moment(d.absence[h].timestamp).format("DD/MM/YYYY HH:mm")+"</td><td class='text-center' onclick='relocate("+d.absence[h].studentID+")'>"+g[0][h].nickname+" "+g[0][h].firstname+"</td><td class='text-center absentSubject"+h+"'></td><td class='text-center absentTutor"+h+"'></td><td class='text-center'>"+d.absence[h].reason+"</td><td class='text-center'><button id='"+d.absence[h].modifierID+"' onClick='removeAttend(this.id);' class='btn btn-light col-12'><span class='fa fa-trash'></span></button></td></tr>"),myFHB(g[0][h].courseID,g[1][h],c,h))})})}function myFHB(a,b,c,d){let e=[];for(let f in b)if(moment(b[f].day).day()==c.day()&&moment(b[f].day).hour()==c.hour())return $(".row"+d).addClass("fhb"),$(".absentTutor"+d).html("HB"),$(".absentSubject"+d).html("FHB:"+b[f].subject),void filterTable();for(let f in a)e.push($.post("post/courseInfo",{courseID:a[f]}));Promise.all(e).then(f=>{for(let g in f)if(f[g].quarter==crQuarter&&moment(f[g].day).day()==c.day()&&moment(f[g].day).hour()==c.hour()){if(99000==f[g].tutor[0])return $(".row"+d).addClass("hb"),$(".absentTutor"+d).html("HB"),$(".absentSubject"+d).html("CR:"+f[g].courseName),void filterTable();$(".row"+d).addClass("cr"),$.post("post/name",{userID:f[g].tutor[0]}).then(h=>{return $(".absentTutor"+d).html(h.nicknameEn),$(".absentSubject"+d).html("CR:"+f[g].courseName),void filterTable()})}})}function filterTable(){let a=$("#filterPick").val();switch(a){case"HB":$(".cr").hide(),$(".hb").show(),$(".fhb").show();break;case"CR":$(".hb").show(),$(".fhb").hide(),$(".cr").show();break;case"FHB":$(".hb").hide(),$(".fhb").show(),$(".cr").hide();break;default:$(".fhb").show(),$(".hb").show(),$(".cr").show();}}function emergencyCheck(a,b){let c=moment(0).year(a.year()).month(a.month()).date(a.date()).hour(18),d=86400000;return 0==a.day()?!!(c.valueOf()-b.valueOf()<2*d):!!(c.valueOf()-b.valueOf()<d)}function removeAttend(a){confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E1A\u0E1B\u0E23\u0E30\u0E27\u0E31\u0E15\u0E34\u0E01\u0E32\u0E23\u0E25\u0E32\u0E19\u0E35\u0E49?")&&$.post("post/removeStudentAttendanceModifier",{modifierID:a}).then(()=>{genCrTable(),genTableByWeek();let b=$(".typeahead").typeahead("getActive");b!=void 0&&genPickedTable(b.id)})}function genPnTable(){$.post("post/v1/listPendingHybridStudent").then(a=>{let b=[];for(let c in a)b.push(name(a[c].studentID));$.post("post/v1/listHybridDayInQuarter",{year:crYear,quarter:crQuarter}).then(c=>{for(let d in c)hybridDay.push(c[d]);Promise.all(b).then(d=>{for(let e in a)for(let f in c)if(a[e].hybridID===c[f].hybridID){let g=moment(parseInt(c[f].day)),h=moment(parseInt(a[e].date)).hour(g.hour());"MODE_ADD_HYBRID"===a[e].mode?$("#pnPresentTable").append("<tr><td class='text-center'>"+h.format("DD/MM/YYYY HH:00")+"</td><td class='text-center'>"+d[e].nickname+" "+d[e].firstname+"</td><td class='text-center'>FHB:"+a[e].subject+"</td></tr>"):$("#pnAbsentTable").append("<tr><td class='text-center'>"+h.format("DD/MM/YYYY HH:00")+"</td><td class='text-center'>"+d[e].nickname+" "+d[e].firstname+"</td><td class='text-center'>FHB:"+a[e].subject+"</td></tr>")}})})})}function genActivityTable(){let a=new Date;a.setHours(6),$.post("post/listAllStudentAttendanceModifier",{start:a.getTime()}).then(b=>{let c=[];for(let d in b.modifier)c.push(name(b.modifier[d].studentID)),c.push($.post("post/courseInfo",{courseID:b.modifier[d].subject}));Promise.all(c).then(d=>{for(let e in b.modifier){let f=moment(parseInt(b.modifier[e].day));if("No timetable"===b.modifier[e].subject)for(let g in hybridDay){let h=moment(hybridDay[g].day);f.day()==h.day()&&f.hour()==h.hour()&&$("#acTableBody").append("<tr class="+("add"===b.modifier[e].reason.slice(0,3)?"table-info":"table-danger")+"><td>"+moment(parseInt(b.modifier[e].timestamp)).format("DD/MM/YYYY HH:mm")+"</td><td onclick='relocate("+b.modifier[e].studentID+")'>"+d[2*e].nickname+" "+d[2*e].firstname+"</td><td>FHB</td><td>"+f.format("DD/MM/YYYY HH:mm")+"</td><td>"+("add"===b.modifier[e].reason.slice(0,3)?"-":b.modifier[e].reason)+"</td><td>"+b.modifier[e].sender+"</td><td class='text-center'><button id='"+b.modifier[e].modifierID+"' onClick='removeAttend(this.id);' class='btn btn-light col-12'><span class='fa fa-trash'></span></button></td></tr>")}else $("#acTableBody").append("<tr class="+("add"===b.modifier[e].reason.slice(0,3)?"table-primary":"table-danger")+"><td>"+moment(parseInt(b.modifier[e].timestamp)).format("DD/MM/YYYY HH:mm")+"</td><td onclick='relocate("+b.modifier[e].studentID+")'>"+d[2*e].nickname+" "+d[2*e].firstname+"</td><td>CR:"+d[2*e+1].courseName+"</td><td>"+f.format("DD/MM/YYYY HH:mm")+"</td><td>"+("add"===b.modifier[e].reason.slice(0,3)?"-":b.modifier[e].reason)+"</td><td>"+b.modifier[e].sender+"</td><td class='text-center'><button id='"+b.modifier[e].modifierID+"' onClick='removeAttend(this.id);' class='btn btn-light col-12'><span class='fa fa-trash'></span></button></td></tr>")}})})}function genTableByName(){let a=[];$.post("post/allStudent").done(b=>{for(let c=0;c<b.student.length;c++)if("active"===b.student[c].status)for(let d=0;d<b.student[c].quarter.length;d++)b.student[c].quarter[d].quarter===summerQ&&a.push({name:b.student[c].nickname+" "+b.student[c].firstname,id:b.student[c].studentID});$(".typeahead").typeahead({source:a,autoSelect:!0}),$(".typeahead").change(function(){let c=$(".typeahead").typeahead("getActive");$("#smAbsentBody").empty(),$("#smPresentBody").empty(),genPickedTable(c.id)})})}function genPickedTable(a){$("#smAbsentBody").empty(),$("#smPresentBody").empty();let b=moment().date(8).month(9);$.post("post/listStudentAttendanceModifierByStudent",{studentID:a,start:b.valueOf()}).done(function(c){let d=moment(0);for(let e=0;e<c.modifier.length;e++)if("\u0E40\u0E1E\u0E34\u0E48\u0E21"===c.modifier[e].reason)$("#smPresentBody").append("<tr><td class='text-center'>"+moment(c.modifier[e].day).format("DD/MM/YYYY")+"</td><td class='text-center'><button id='"+c.modifier[e].modifierID+"' onClick='removeAttend(this.id);'><span class='fa fa-trash'></span></button></td></tr>");else if("\u0E25\u0E32"===c.modifier[e].reason){let f=moment(c.modifier[e].day).date()===d.date()&&moment(c.modifier[e].day).month()===d.month()&&moment(c.modifier[e].day).year()===d.year();f?(8===moment(c.modifier[e].day).hour()&&$(".a:last").html("\u2713").attr("id",c.modifier[e].modifierID).attr("onClick","removeAttend(this.id);"),10===moment(c.modifier[e].day).hour()&&$(".b:last").html("\u2713").attr("id",c.modifier[e].modifierID).attr("onClick","removeAttend(this.id);"),13===moment(c.modifier[e].day).hour()&&$(".c:last").html("\u2713").attr("id",c.modifier[e].modifierID).attr("onClick","removeAttend(this.id);")):(d=moment(c.modifier[e].day),$("#smAbsentBody").append("<tr></tr>"),$("#smAbsentBody tr:last-child").append("<td class='text-center'>"+moment(c.modifier[e].day).format("DD/MM/YYYY")+"</td><td class='text-center a' id='"+c.modifier[e].modifierID+"' onClick='removeAttend(this.id);'>"+(8===moment(c.modifier[e].day).hour()?"\u2713":"-")+"</td><td class='text-center b' id='"+c.modifier[e].modifierID+"' onClick='removeAttend(this.id);'>"+(10===moment(c.modifier[e].day).hour()?"\u2713":"-")+"</td><td class='text-center c' id='"+c.modifier[e].modifierID+"' onClick='removeAttend(this.id);'>"+(13===moment(c.modifier[e].day).hour()?"\u2713":"-")+"</td>"))}})}function genTableByWeek(){$("#smWeekBody").empty();const a=parseInt($("#weekSelect").val()),b=[8,10,13,15];let c=[];for(let d=a;d<a+5;d++)for(let e in b){let f=moment(0).date(d).month(summerMonth).year(summerYear).hour(b[e]);c.push($.post("post/listStudentAttendanceModifierByDay",{day:f.valueOf()}),f)}Promise.all(c).then(d=>{for(let e=0;e<d.length;e+=2)for(let f in d[e].absence)"\u0E25\u0E32"==d[e].absence[f].reason?$("#smWeekBody").append("<tr class='table-danger smAbsentRow'><td class='text-center'>"+d[e].absence[f].studentID+"</td><td id='name"+e+f+"'></td><td class='text-center'>"+d[e+1].format("DD/MM/YYYY")+"</td><td class='text-center'>"+d[e+1].format("HH:mm")+"</td><td class='text-center'><button id='"+d[e].absence[f].modifierID+"' onClick='removeAttend(this.id);'><span class='fa fa-trash'></span></button></td></tr>"):"\u0E40\u0E1E\u0E34\u0E48\u0E21"==d[e].absence[f].reason&&$("#smWeekBody").append("<tr class='table-success smPresentRow'><td class='text-center'>"+d[e].absence[f].studentID+"</td><td id='name"+e+f+"'></td><td class='text-center'>"+d[e+1].format("DD/MM/YYYY")+"</td><td class='text-center'>"+d[e+1].format("HH:mm")+"</td><td class='text-center'><button id='"+d[e].absence[f].modifierID+"' onClick='removeAttend(this.id);'><span class='fa fa-trash'></span></button></td></tr>"),filterSmTable(),weekDayGetName(e,f,d[e].absence[f].studentID)})}function weekDayGetName(a,b,c){$.post("post/name",{userID:c}).then(e=>{let f=e.firstname+" ("+e.nickname+") "+e.lastname;$("#"+("name"+a+b)).html(f)})}function filterSmTable(){let a=$("#typeSelect").val();switch(a){case"1":$(".smPresentRow").hide(),$(".smAbsentRow").show();break;case"2":$(".smPresentRow").show(),$(".smAbsentRow").hide();break;default:$(".smPresentRow").show(),$(".smAbsentRow").show();}}function genSmCrPick(){$.post("post/allCourse",{year:summerYear,quarter:summerQ}).then(a=>{for(let b in a.course)$("#smCrSelect").append("<option value='"+a.course[b].courseID+"'>"+a.course[b].courseName+"</option>")})}function genSmTableByCr(){$("#smCrBody").empty(),$.post("post/courseInfo",{courseID:$("#smCrSelect").val()}).then(a=>{let b=[],c=moment(0).year(2017).month(9).date(8).valueOf();for(let d in a.student)b.push($.post("post/name",{userID:a.student[d]}),$.post("post/listStudentAttendanceModifierByStudent",{studentID:a.student[d],start:c}));Promise.all(b).then(d=>{for(let e=0;e<d.length;e+=2){let f="",g="";for(let h=0;15>h;h++)5>h?(f+="<td id='smCrAbsentCell"+e+(h+9)+"'></td>",g+="<td id='smCrPresentCell"+e+(h+9)+"'></td>"):10>h?(f+="<td id='smCrAbsentCell"+e+(h+11)+"'></td>",g+="<td id='smCrPresentCell"+e+(h+11)+"'></td>"):(f+="<td id='smCrAbsentCell"+e+(h+13)+"'></td>",g+="<td id='smCrPresentCell"+e+(h+13)+"'></td>");for(let h in $("#smCrBody").append("<tr><td rowspan='2'>"+d[e].nickname+" "+d[e].firstname+" "+d[e].lastname+"</td>"+f+"</tr><tr>"+g+"</tr>"),d[e+1].modifier){let k=moment(d[e+1].modifier[h].day).date();"\u0E25\u0E32"==d[e+1].modifier[h].reason?$("#smCrAbsentCell"+e+k).addClass("table-danger"):"\u0E40\u0E1E\u0E34\u0E48\u0E21"==d[e+1].modifier[h].reason&&$("#smCrPresentCell"+e+k).addClass("table-success")}}})})}