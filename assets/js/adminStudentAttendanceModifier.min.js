let genTutor=(()=>{var c=_asyncToGenerator(function*(){let d=yield $.post("post/v1/listTutor");for(let e in d.sort(function(e,f){return e.tutorID-f.tutorID}),d)$("#crFilterPick").append("<option value="+d[e].tutorID+">"+d[e].nicknameEn+"</option>");genTable(2)});return function(){return c.apply(this,arguments)}})(),genTable=(()=>{var c=_asyncToGenerator(function*(d){let e;1===d?($("#fhbAbsentTable").empty(),$("#fhbPresentTable").empty(),e=$("#fhbDatePicker").data("DateTimePicker").date()):($("#crAbsentTable").empty(),e=$("#crDatePicker").data("DateTimePicker").date()),e.hour(0);let f=yield $.post("post/v1/listAttendance",{date:e.valueOf()}),g=[],h=[];for(let l in f)h.push(name(f[l].userID)),0===f[l].courseID?g.push($.post("post/v1/studentHybridSubject",{studentID:f[l].userID,hybridID:f[l].hybridID})):g.push(courseInfo(f[l].courseID));let j=yield Promise.all(g),k=yield Promise.all(h);for(let l=0;l<f.length;l++){let p,q,r,m=moment(f[l].timestamp).format("ddd DD/MM/YY HH:mm"),n=moment(f[l].date).hour(),o="";switch(r=void 0!==f[l].link&&""!==f[l].link?"<span class='fa fa-lg fa-folder-open' onclick='showAdtendPic(\""+f[l].link+"\")'></span>":"<span class='fa fa-lg fa-plus-circle' onclick='showUploadModal(\""+f[l].attendanceID+"\")'></span>",emergencyAbsent(f[l].timestamp,f[l].date)&&(o="table-warning"),f[l].remark){case"1":p="<span class='fa fa-lg fa-check-circle-o' style='color:orange'></span>",q="next2";break;case"2":p="<span class='fa fa-lg fa-check-circle-o' style='color:green'></span>",q="next0";break;default:p="<span class='fa fa-lg fa-times-circle-o' style='color:red'></span>",q="next1";}if(1===f[l].type){let s,u,v;if(0===f[l].courseID)s="FHB:"+j[l].subject,u="HB",v="FHB";else if(s="CR:"+j[l].courseName,99000===j[l].tutor[0])u="HB",v="HB";else{let w=yield name(j[l].tutor[0]);u=w.nicknameEn,v="CR"}"CR"!==v&&1===d?$("#fhbAbsentTable").append("<tr id='"+f[l].attendanceID+"' class='fhbTableRow fhbRow"+n+" "+v+" "+o+"'><td class='text-center'>"+m+"</td><td class='text-center' onclick='gotoStdProfile(\""+f[l].userID+"\")'>"+k[l].nickname+" "+k[l].firstname+"</td><td class='text-center'>"+s+"</td><td class='text-center'>"+u+"</td><td class='text-center'>"+f[l].reason+"</td><td class='text-center'>"+r+"</td><td class='text-center "+q+" rm"+f[l].attendanceID+"' onclick='setRemark(\""+f[l].attendanceID+"\")'>"+p+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+f[l].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>"):"FHB"!==v&&2==d&&$("#crAbsentTable").append("<tr id='"+f[l].attendanceID+"' class='crTableRow crRow"+n+" "+j[l].tutor[0]+" "+o+"'><td class='text-center'>"+m+"</td><td class='text-center' onclick='gotoStdProfile(\""+f[l].userID+"\")'>"+k[l].nickname+" "+k[l].firstname+"</td><td class='text-center'>"+s+"</td><td class='text-center'>"+u+"</td><td class='text-center'>"+f[l].reason+"</td><td class='text-center'>"+r+"</td><td class='text-center "+q+" rm"+f[l].attendanceID+"' onclick='setRemark(\""+f[l].attendanceID+"\")'>"+p+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+f[l].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>")}else 1===d&&$("#fhbPresentTable").append("<tr id='"+f[l].attendanceID+"' class='fhbTableRow fhbRow"+n+"'><td class='text-center'>"+m+"</td><td class='text-center' onclick='gotoStdProfile(\""+f[l].userID+"\")'>"+k[l].nickname+" "+k[l].firstname+"</td><td class='text-center'>FHB:"+f[l].subject+"</td><td class='text-center "+q+" rm"+f[l].attendanceID+"' onclick='setRemark(\""+f[l].attendanceID+"\")'>"+p+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+f[l].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>")}filterFhbTable(1),filterFhbTable(2)});return function(){return c.apply(this,arguments)}})(),genActivityTable=(()=>{var c=_asyncToGenerator(function*(d){acTime1.date(acTime1.date()-4),0!==d&&acTime2.date(acTime2.date()-4);let e=yield $.post("post/v1/listAttendance",{startDate:acTime1.valueOf(),endDate:acTime2.valueOf()}),f=[],g=[];for(let k in e)g.push(name(e[k].userID)),0===e[k].courseID?f.push($.post("post/v1/studentHybridSubject",{studentID:e[k].userID,hybridID:e[k].hybridID})):f.push(courseInfo(e[k].courseID));let h=yield Promise.all(f),j=yield Promise.all(g);0===e.length&&$("#loadMoreButt").hide();for(let k=0;k<e.length;k++){let l,m=moment(e[k].timestamp).format("ddd DD/MM/YY - HH:mm"),n,o=moment(e[k].date).format("ddd DD/MM/YY - HH:mm"),p,q;1===e[k].type?(l="table-danger",n=0===e[k].courseID?"FHB:"+h[k].subject:"CR:"+h[k].courseName,p=e[k].reason):(l="table-success",n="FHB:"+e[k].subject,p="-"),q=void 0!==e[k].link&&""!==e[k].link?"<span class='fa fa-lg fa-folder-open' onclick='showAdtendPic(\""+e[k].link+"\")'></span>":"<span class='fa fa-lg fa-plus-circle' onclick='showUploadModal(\""+e[k].attendanceID+"\")'></span>",$("#acTableBody").append("<tr class='"+l+"' id='"+e[k].attendanceID+"'><td class='text-center'>"+m+"</td><td class='text-center' onclick='gotoStdProfile(\""+e[k].userID+"\")'>"+j[k].nickname+" "+j[k].firstname+"</td><td class='text-center'>"+n+"</td><td class='text-center'>"+o+"</td><td class='text-center'>"+p+"</td><td class='text-center'>"+q+"</td><td class='text-center'>"+e[k].sender+"</td><td class='text-center'><button class='btn btn-light col' onclick='removeAdtend(\""+e[k].attendanceID+"\")'><span class='fa fa-lg fa-trash' style='color:red'></span></button></td></tr>")}});return function(){return c.apply(this,arguments)}})(),sendAddAdtendData=(()=>{var c=_asyncToGenerator(function*(){let d=$("#addDatePicker").data("DateTimePicker").date(),e=$("#addType").val(),f=parseInt($("#addTime").val()),g=$("#addStdID").val(),h=$("#addSubj").val();if("1"===e){let j=[],k=yield $.post("post/v1/studentTimeTable",{year:year,quarter:quarter,studentID:g}),l=k.course;for(let n in l){let o=moment(l[n].day);o.day()===d.day()&&o.hour()===f&&j.push($.post("post/v1/addStudentAbsent",{userID:g,date:roundTime(d,f),courseID:l[n].courseID,reason:$("#addReason").val(),sender:"Admin"}))}let m=k.hybrid;for(let n in m){let o=moment(m[n].day);o.day()===d.day()&&o.hour()===f&&j.push($.post("post/v1/addStudentAbsent",{userID:g,date:roundTime(d,f),hybridID:m[n].hybridID,reason:$("#addReason").val(),sender:"Admin"}))}location.reload()}else{let j=yield $.post("post/v1/listHybridDayInQuarter",{year:year,quarter:quarter}),k;for(let l in j){let m=moment(j[l].day);m.day()===d.day()&&m.hour()===f&&(k=j[l].hybridID)}yield $.post("post/v1/addStudentPresent",{userID:g,date:roundTime(d,f),hybridID:k,subject:h,sender:"Admin"}),location.reload()}});return function(){return c.apply(this,arguments)}})();function _asyncToGenerator(c){return function(){var d=c.apply(this,arguments);return new Promise(function(e,f){function g(h,j){try{var k=d[h](j),l=k.value}catch(m){return void f(m)}return k.done?void e(l):Promise.resolve(l).then(function(m){g("next",m)},function(m){g("throw",m)})}return g("next")})}}let year,quarter;getYearAndQuarter();function getYearAndQuarter(){getConfig().then(c=>{year=c.defaultQuarter.quarter.year,quarter=c.defaultQuarter.quarter.quarter})}$("#fhbDatePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5]}),$("#crDatePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,2,3,4,5]}),genTimePicker(1),genTable(1),genTimePicker(2),genTutor(),$("#fhbDatePicker").on("dp.change",function(){genTimePicker(1),genTable(1)}),$("#crDatePicker").on("dp.change",function(){genTable(2)});function genTimePicker(c){let d,e;1===c?(d=$("#fhbTimePick"),e=$("#fhbDatePicker").data("DateTimePicker").date()):(d=$("#crTimePick"),e=$("#crDatePicker").data("DateTimePicker").date()),d.empty(),2===e.day()||4===e.day()?d.append("<option value=17>17-19</option>"):d.append("<option value=0>All</option><option value=8>8-10</option><option value=10>10-12</option><option value=13>13-15</option><option value=15>15-17</option>")}function emergencyAbsent(c,d){let e=!1,f=86400000,g=moment(d);return g.hour(18).minute(0).second(0).millisecond(0),0===g.day()?g.valueOf()-c<2*f&&(e=!0):g.valueOf()-c<f&&(e=!0),e}function filterFhbTable(c){let d,e;if(1===c?(d=$("#fhbTimePick").val(),e=$("#fhbFilterPick").val()):(d=$("#crTimePick").val(),e=$("#crFilterPick").val()),1===c)switch("0"===d?$(".fhbTableRow").show():($(".fhbTableRow").hide(),$(".fhbRow"+d).show()),e){case"FHB":$(".HB").hide();break;default:}else if("0"!==d){let f=["8","10","13","15"];"0"===e?$(".crTableRow").show():($(".crTableRow").hide(),$("."+e).show());for(let g=0;4>g;g++)f[g]!==d&&$(".crRow"+f[g]).hide()}else"0"===e?$(".crTableRow").show():($(".crTableRow").hide(),$("."+e).show())}$("#fhbTimePick").change(function(){filterFhbTable(1)}),$("#fhbFilterPick").change(function(){filterFhbTable(1)}),$("#crTimePick").change(function(){filterFhbTable(2)}),$("#crFilterPick").change(function(){filterFhbTable(2)});function removeAdtend(c){confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E1A\u0E1B\u0E23\u0E30\u0E27\u0E31\u0E15\u0E34\u0E19\u0E35\u0E49?")&&$.post("post/v1/deleteAttendance",{attendanceID:c}).then(d=>{log(d),$("#"+c).remove()})}function gotoStdProfile(c){writeCookie("monkeyWebAdminAllstudentSelectedUser",c),self.location="/adminStudentprofile"}function setRemark(c){let e=$(".rm"+c);e.hasClass("next0")?$.post("post/v1/setAttendanceRemark",{attendanceID:c,remark:"0"}).then(f=>{log(f),e.removeClass("next0").addClass("next1"),e.html("<span class='fa fa-lg fa-times-circle-o' style='color:red'></span>")}):e.hasClass("next1")?$.post("post/v1/setAttendanceRemark",{attendanceID:c,remark:"1"}).then(f=>{log(f),e.removeClass("next1").addClass("next2"),e.html("<span class='fa fa-lg fa-check-circle-o' style='color:orange'></span>")}):e.hasClass("next2")&&$.post("post/v1/setAttendanceRemark",{attendanceID:c,remark:"2"}).then(f=>{log(f),e.removeClass("next2").addClass("next0"),e.html("<span class='fa fa-lg fa-check-circle-o' style='color:green'></span>")})}$(".remarkReset").click(function(){confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23 reset remark \u0E17\u0E31\u0E49\u0E07\u0E2B\u0E21\u0E14?")&&$.post("post/v1/resetAttendanceRemark").then(c=>{log(c),location.reload()})});let acTime1=moment(),acTime2=moment();genActivityTable(0),$("#loadMoreButt").click(function(){genActivityTable(1)});function showAdtendPic(c){$("#picSrc").attr("src",c),$("#picModal").modal("show")}let uploadID;function showUploadModal(c){uploadID=c,$("#picUploadModal").modal("show")}$("#uploadPicButt").click(function(){confirm("\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E40\u0E1E\u0E34\u0E48\u0E21\u0E2B\u0E25\u0E31\u0E01\u0E10\u0E32\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32?")&&uploadAdtendPic()});function uploadAdtendPic(){let c=$("#file-img"),d=c.val().split(".").pop().toLowerCase();if(-1===$.inArray(d,["png","jpg","jpeg"]))alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E2D\u0E31\u0E1E\u0E44\u0E1F\u0E25\u0E4C .jpg, .jpeg \u0E2B\u0E23\u0E37\u0E2D .png \u0E40\u0E17\u0E48\u0E32\u0E19\u0E31\u0E49\u0E19");else{let e=c.get(0).files,f=new FormData,g=e[0];f.append("files",g,g.name),f.append("attendanceID[]",uploadID),$.ajax({url:"post/v1/uploadAttendanceDocument",type:"POST",data:f,processData:!1,contentType:!1,success:function(){location.reload()}})}}$("#addType").change(function(){loadAdtendPage()}),loadAdtendPage();function loadAdtendPage(){let c=$("#addType").val();"1"===c?($(".absentContent").show(),$(".addContent").hide()):($(".absentContent").hide(),$(".addContent").show())}$("#addDatePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5]}),genAddAdtendTimePicker(),$("#addDatePicker").on("dp.change",function(){genAddAdtendTimePicker()});function genAddAdtendTimePicker(){$("#addTime").empty();let c=$("#addDatePicker").data("DateTimePicker").date();2===c.day()||4===c.day()?$("#addTime").append("<option value=17>17-19</option>"):$("#addTime").append("<option value=8>8-10</option><option value=10>10-12</option><option value=13>13-15</option><option value=15>15-17</option>")}$("#addNewAttend").click(function(){let c=$("#addType").val();""===$("#addStdID").val()?alert("Input studentID"):5===$("#addStdID").val().length?"1"===c?""===$("#addReason").val()?alert("Input reason"):confirm("\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32?")&&sendAddAdtendData():confirm("\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E40\u0E1E\u0E34\u0E48\u0E21?")&&sendAddAdtendData():alert("Incorrect studentID")});const roundTime=(c,d)=>{let e=moment(0);return e.year(c.year()).month(c.month()).date(c.date()).hour(parseInt(d)),e.valueOf()};