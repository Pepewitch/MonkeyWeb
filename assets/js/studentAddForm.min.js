var useM=0,useP=0,maxM=0,maxP=0,firstname="",nickname="";$(document).ready(function(){let a=getCookieDict(),b=a.monkeyWebUser,c=2017,d=4,e=[],f=[];$("#datePicker").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5],minDate:moment()}),$.post("post/getConfig",g=>{c=g.defaultQuarter.quarter.year,d=g.defaultQuarter.quarter.quarter,$("#pageHead").html("CR60Q"+g.defaultQuarter.quarter.quarter+" & FHB")}).then($.post("post/studentProfile",{studentID:b},g=>{nickname=g.nickname,firstname=g.firstname;let h=[];for(let k in g.courseID)h.push($.post("post/courseInfo",{courseID:g.courseID[k]}));Promise.all([Promise.all(h).then(k=>{for(let l in k)k[l].quarter===d&&e.push(k[l])}),$.post("post/v1/listStudentHybrid",{studentID:b,year:c,quarter:d},k=>{for(let l in k)f.push(k[l]),"M"==k[l].subject?maxM+=3:maxP+=3})]).then(()=>{fillTable(b,f,e),fillButt(e,f)})})),$("#datePicker").on("dp.change",function(){fillTable(b,f,e),fillButt(e,f)}),$(".selector").click(function(){$(this).hasClass("disabled")||($(".btn-success").toggleClass("btn-default btn-success"),$(this).toggleClass("btn-default btn-success"))}),$("#submit").click(function(){0==$(".btn-success").length?alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E40\u0E25\u0E37\u0E2D\u0E01\u0E40\u0E27\u0E25\u0E32\u0E17\u0E35\u0E48\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E40\u0E1E\u0E34\u0E48\u0E21"):$("#senderInput").val()?sendData(b):alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E0A\u0E37\u0E48\u0E2D\u0E1C\u0E39\u0E49\u0E41\u0E08\u0E49\u0E07")})});function fillButt(a,b){$(".selector").addClass("btn-default").removeClass("disabled btn-success course");let c=$("#datePicker").data("DateTimePicker").date();if(2==c.day()||4==c.day())for(let d in $("#btn8").html("17-19"),$("#btn10").html("&nbsp;"),$("#btn13").html("&nbsp;"),$("#btn15").html("&nbsp;"),b)moment(b[d].day).day()==c.day()&&$("#btn8").html("FHB:"+b[d].subject.slice(0,1)).addClass("disabled");else{for(let d in $("#btn8").html("8-10"),$("#btn10").html("10-12"),$("#btn13").html("13-15"),$("#btn15").html("15-17"),b)moment(b[d].day).day()==c.day()&&$("#btn"+moment(b[d].day).hour()).html("FHB:"+b[d].subject.slice(0,1)).addClass("disabled course");for(let d in a)moment(a[d].day).day()==c.day()&&$("#btn"+moment(a[d].day).hour()).html(a[d].courseName).addClass("disabled course")}}function fillTable(a,b,c){useP=0,useM=0,$("#absentTableBody").empty(),$("#presentTableBody").empty();let d=$("#datePicker").data("DateTimePicker").date(),e=moment(0).year(d.year()).month(d.month()-3).date(d.date());$.post("post/listStudentAttendanceModifierByStudent",{studentID:a,start:e.valueOf()},f=>{for(let g in f.modifier)if("addFHB:M"==f.modifier[g].reason)useM-=1,$("#presentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+" - <strong>FHB:M</strong></td></tr>");else if("addFHB:P"==f.modifier[g].reason)useP-=1,$("#presentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+"- <strong>FHB:P</strong></td></tr>");else if("\u0E25\u0E32"!=f.modifier[g].reason&&"\u0E40\u0E1E\u0E34\u0E48\u0E21"!=f.modifier[g].reason){for(let h=0;h<b.length;h++)if(moment(b[h].day).hour()==moment(f.modifier[g].day).hour()&&moment(b[h].day).day()==moment(f.modifier[g].day).day()){let k="";"M"==b[h].subject?(useM+=1,k="FHB:M"):(useP+=1,k="FHB:P"),$("#absentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+" - <strong>"+k+"</strong></td></tr>")}for(let h=0;h<c.length;h++)moment(c[h].day).hour()==moment(f.modifier[g].day).hour()&&moment(c[h].day).day()==moment(f.modifier[g].day).day()&&$("#absentTableBody").append("<tr><td class='text-center'>"+moment(f.modifier[g].day).format("ddd DD MMM HH:mm")+" - <strong>"+c[h].courseName+"</strong></td></tr>")}$("#mathSum").html("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:M \u0E40\u0E2B\u0E25\u0E37\u0E2D "+(maxM-useM)+"/"+maxM),$("#phySum").html("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:P \u0E40\u0E2B\u0E25\u0E37\u0E2D "+(maxP-useP)+"/"+maxP)})}function sendData(a){let b=$("#datePicker").data("DateTimePicker").date();sendAbsentModifier(a,b)}function sendAbsentModifier(a,b){if(confirm("\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E40\u0E1E\u0E34\u0E48\u0E21")){$("#loaderModal").modal();let c=[],d="\n"+nickname+" "+firstname+"\n\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E40\u0E1E\u0E34\u0E48\u0E21:";if(2==b.day()||4==b.day())for(let e=0;e<$(".btn-success").length;e++)c.push(b.hour(17).minute(0).second(0).millisecond(0).valueOf()),d+="\n"+$("#subjInput").val().slice(0,5),d+=" - "+b.format("ddd DD/MM/YYYY \u0E23\u0E2D\u0E1A HH:mm");else for(let f,e=0;e<$(".btn-success").length;e++)f=$($(".btn-success")[e]).attr("id").slice(3),c.push(b.hour($($(".btn-success")[e]).attr("id").slice(3)).minute(0).second(0).millisecond(0).valueOf()),d+="\n"+$("#subjInput").val().slice(0,5),d+=" - "+b.format("ddd DD/MM/YYYY \u0E23\u0E2D\u0E1A HH:mm");$.post("post/addStudentAbsenceModifier",{studentID:a,day:c,reason:"add"+$("#subjInput").val().slice(0,5),sender:$("#senderInput").val()},()=>{$.post("post/lineNotify",{recipient:"MonkeyAdmin",message:d},()=>{location.reload()})})}}